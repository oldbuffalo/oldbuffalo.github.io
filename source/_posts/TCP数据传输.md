---
title: TCP数据传输
date: 2019-03-10 16:10:33
tags:
- TCP
- 网络
- Linux高性能服务器编程
---

## TCP交互数据流

交互数据仅包含很少的字节，使用交互数据的应用程序(或协议)对实时性要求高，比如telnet、ssh等

#### 延迟确认

延迟确认：每次需要发送的确认报文段不马上发送，而是在一段延迟时间后查看本端是否有数据需要发送，如果有，就和确认信息一起发出。延迟确认可以减少发送TCP报文段的数量，提高通信效率。

一般服务器对客户请求处理得很快，所以它发送确认报文段的时候总有数据一起发送，常用延迟确认。而客户端用户的输入速度明显慢于客户端程序的处理速度，所以客户端的确认报文一般不携带任何应用程序数据。

在TCP四次挥手的时候，也有可能发生延迟确认。（确认客户端FIN包的ACK包可以和应用数据一起发送）

#### Nagle算法

在广域网中，交互数据流可能经受很大的延迟，并且，如果携带交互数据流的微小TCP报文段数量很多的时候(一个按键就导致一个TCP报文段)，可能导致拥塞发生，影响网络性能。

解决方案是:Nagle算法

Nagle算法要求当一个TCP连接中有在传数据(即那些已发送但还未经确认的数据)，小的报文段(长度小于SMSS)就不能发送，直到所有的在传数据都收到ACK。并且，在收到ACK后，TCP需要收集这些小数据，将其整合到一个报文段中发送。迫使TCP遵循停等规程。这样就极大地减少了网络上的微小TCP报文段的数量，另一个优点是自适应性：确认到达得越快，数据也就发送得越快。

## TCP成块数据流

成块数据的长度通常为TCP报文段允许的最大数据长度，使用成块数据的应用程序（或协议）对传输效率要求高，比如ftp。

当传输大量大块数据的时候，发送方会连续发送多个TCP报文段，接收方可以一次确认所有这些报文段。

发送方在收到上一次确认后，能连续发送多少个TCP报文段取决于接收通告窗口大小和拥塞窗口大小。

可以修改TCP接收缓冲区和发送缓冲区的大小。

## 带外数据

用来迅速通告对方本端发生的重要事件，因此带外数据比普通数据有更高的优先级，应该总是立即被发送，而不论发送缓冲区中是否有排队等待发送的普通数据。

带外数据的传输可以使用一条独立的传输层连接，也可以映射到传输普通数据的连接上。

UDP没实现带外数据传输，TCP也没真正的带外数据，但是TCP可以利用头部中的紧急指针标志和紧急指针两个字段，给应用程序提供一种紧急方式。TCP的紧急方式利用传输普通数据的连接来传输紧急数据。

![](/pic/TCP带外数据.png)

假设一个进程已经往某个TCP连接的发送缓冲区中写入了N个字节的普通数据，并等待其发送。在数据被发送之前，该进程又向这个连接写入了3字节的带外数据"abc"，此时，待发送的TCP报文段的头部被设置URG标志，且紧急指针被设置成指向最后一个带外数据的下一字节。

发送端一次发送的多字节带外数据中只有最后一字节被当作带外数据(c)，而其他数据(a、b)被当成普通数据。如果TCP以多个TCP报文段来发送上图所示TCP发送缓冲区中的内容，则每个TCP报文段都将设置自URG标志，并且它们的紧急指针指向同一位置，但只有一个TCP报文段真正携带带外数据。

TCP接收带外数据，接收端只有在接收到紧急指针标志时才检查紧急指针，然后根据紧急指针所指位置确定带外数据位置，并将它读入一个特殊的缓存，这个缓存只有1字节，称为带外缓存。如果上层应用没有及时将带外数据从带外缓存中读出，后续的带外数据将覆盖它。

上面的接收方式是TCP默认的接收方式，如果给TCP连接设置SO_OOBINLINE，那么带外数据将和普通数据一样被TCP模块存放在TCP接收缓冲区内。那么这样如何区分带外数据和普通数据? 1.紧急指针可以用来指出带外数据的位置2.socket编程接口提供了识别带外数据的系统调用

## 数据传输超时重传

区别于三次握手的时候的超时重连策略

TCP超时重传策略：如果某个数据报在规定时间内没收到确认包，接下来一共执行5次重传，间隔分别是0.2s、0.4s、0.8s、1.6s、3.2s。

Linux中有两个重要的内核参数与TCP超时重传有关。 

/proc/sys/net/ipv4/tcp_retries1 :  指定底层IP接管之前TCP最少执行的重传次数，默认值是3

/proc/sys/net/ipv4/tcp_retries2 : 指定连接放弃前TCP最多可以执行的重传次数，默认值是15(一般对应13~30min)

