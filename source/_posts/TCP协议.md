---
title: TCP协议
date: 2018-11-17 19:50:26
tags: 
- TCP
- 网络
- Linux高性能服务器编程
---

## TCP特点

TCP全称叫传输控制协议，是传输层两大协议之一。

TCP是一种面向连接的、可靠的、数据流的协议。连接方式是一对一，类似于打电话，数据交互之前需要连接，然后才可以通信。

TCP的可靠体现在:

- 传输数据之前需要建立连接
- 发送应答机制(数据需要确认)
- 发送端超时重传(丢包)
- 乱序重组(根据序列号)
- 校验码校验
- 滑动窗口
- 拥塞控制

<!-- more -->

## TCP首部

![TCP首部](/pic/TCP首部.png)

1.源端口和目标端口很好理解，传输层就是实现端到端的通信的。
简单介绍一下端口号。端口就是用来标识一个网络应用的。范围是0-66635,
1-1023是知名端口号，由Internet号分配机构管理。
1024-5000是临时端口，大于5000的是为其他服务器预留的

一些知名端口号:
![知名端口号](/pic/知名端口号.png)

2.序号 :《TCP/IP:协议》上是这么解释的，用来标识从TCP发端向TCP收端发送的数据字节流，它标识在这个报文段中的第一个数据字节。用序号对每个字节进行技术，序号到达最大值(2的32次-1)再从0开始。初始序号是随机的。

简而言之，序号就是对已发数据字节进行计数的。

3.确认序号 :确认接收端已经收到了发送端前n个字节，请求第n+1个字节开始的数据
因此确认序号是上次已成功收到数据字节序号加1

4.首部长度: 给出首部中32bit字(4字节)的数目，由于不加选项的TCP首部至少是20个字节，因此首部长度最小为5，由于首部长度这个字段占4位，因此TCP首部最多有60个字节。

5.六个标志位   置1代表触发

URG  紧急指针有效
ACK   确认序号有效
PSH   接收方应该尽快将这个报文段交给应用层
RST   重建连接
SYN  同步序号用来发起一个连接
FIN   发端完成发送任务

6.窗口大小   TCP利用滑动窗口进行流量控制

7.检验和  强制性字段   用于收端进行验证

8.紧急指针  是一个正的偏移量(很少用)

9.选项     

- 比较常见的是最长报文大小(MSS) ,在建立连接的第一个报文指定
- 窗口扩大选项(3个字节，每个字节表示移位值)
- 时间戳选项(10个字节)   时间戳值和时间戳回送回答字段

## TCP头部选项

选项最多40字节，加上固定头部20字节，TCP头部最多60字节

TCP头部选项一般结构：

![](/pic/TCP头部选项一般结构.png)

常见的7种TCP头部选项：

![](/pic/常见TCP头部选项.png)

- kind = 0 选项表结束选项

- kind = 1 空操作选项，没什么含义，一般用来将TCP选项总长度填充为4字节整数倍

- kind = 2 最大报文段长度选项(MSS)，在连接初始化协商，TCP模块通常设置成(MTU-40)字节，去除20字节的TCP头部和20字节的IP头部（假设都不加选项），避免本机IP分片，对以太网而言，MSS一般为1460

- kind = 3 窗口扩大因子选项。在连接初始化协商。在TCP头部接收通告窗口大小是16位表示，最大是65536字节，但实际上TCP模块允许的接收通告窗口大小远不止这个数(为了提高TCP吞吐量)，窗口扩大因子(移位数，取值范围0-14)，假设接收窗口一开始大小为M，窗口扩大因子是N，实际接收窗口大小为M*2^N。

  可以修改/proc/sys/net/ipv4/tcp_window_scaling内核变量来启用或者关闭窗口扩大因子选项

  注意点：和MSS选项一样，窗口扩大因子只能出现在同步报文段中，否则将被忽略。但同步报文段本身不执行窗口扩大操作，即同步报文段头部的接收通告窗口大小就是该TCP报文段的实际接收通告窗口大小。当连接建立之后，每个数据传输方向的窗口扩大因子就固定不变了。(我懵逼了，不懂什么意思)

- kind = 4 ，选择性确认(SACK)。如果某个TCP报文段丢失，TCP模块会重传最后被确认的TCP报文段后续的所有报文段，这样原先有些已经正确传输但在丢失报文段之后的报文就会被重复发送，从而降低TCP性能。SACK能够改善这种情况，使TCP模块只重新发送丢失的TCP报文段。

  可以修改/proc/sys/net/ipv4/tcp_sack内核变量来启用或关闭选择性确认选项

- kind = 5 ，SACK实际工作的选项。该选项的参数告诉发送方已经收到并缓存的不连续的数据块，从而让发送端可以据此检查并重发丢失的数据块。块左边沿表示不连续块的第一个数据序号，块右边沿表示不连续块的最后一个数据序号的下一个序号，这一对参数之间的数据是没有收到的，占用8字节。

- kind = 8 ,时间戳选项。提供较为精确的计算通信双方之间的回路时间(RTT)的方法，从而为TCP流量控制提供重要信息。

  可以修改/proc/sys/net/ipv4/tcp_timestamps内核变量来启用或关闭时间戳选项

## tcpdump抓包观察TCP头部

![](/pic/tcp抓包1.png)

抓取到的数据包：

![](/pic/tcp抓包2.png)

Flags[S]:表示TCP报文段中有SYN标志，是一个同步报文段

seq:序号值。该同步报文值是从127.0.0.1.34278（客户端）到127.0.0.1.23（服务器）这个传输方向上的第一个TCP报文段，所以这个序号值也是这次通信过程中该传输方向上的ISN值。

win:接收通告窗口大小。因为这是一个同步报文段，所以反映的是实际接收通告大小

options：TCP选项。mss是发送端(客户端通告的最大报文段长度)、sackOK表示发送端支持并同意使用SACK选项、TS val是发送端的时间戳、ecr是时间戳回显应答、nop是一个空操作选项、wscale是发送端使用的窗口扩大因子。

前20字节是IP头部，后40字节是TCP头部

因此从第21字节开始分析

| 十六进制数 | 十进制表示 | TCP头部信息                               |
| ---------- | ---------- | ----------------------------------------- |
| 0x85e6     | 34278      | 源端口号                                  |
| 0x0017     | 23         | 目的端口号                                |
| 0x599d891d | 1503496477 | 序号                                      |
| 0x00000000 | 0          | 确认号                                    |
| 0xa        | 10         | 头部长度时10*4字节                        |
| 0x002      |            | 设置了SYN标志                             |
| 0xaaaa     | 43690      | 接收通告窗口大小                          |
| 0xfe30     |            | 头部校验和                                |
| 0x0000     |            | 没设置URG标志，所以紧急指针无意义         |
| 0x0204     |            | 最大报文段长度(MSS)选项的kind值和length值 |
| 0xffd7     | 65495      | 最大报文段长度                            |
| 0x0402     |            | 允许SACK选项                              |
| 0x080a     |            | 时间戳选项的kind值和length值              |
| 0x001cdf6d | 1892205    | 时间戳                                    |
| 0x00000000 | 0          | 时间戳回显应答                            |
| 0x01       |            | 空操作选项(nop)                           |
| 0x0303     |            | 窗口扩大因子选项的kind值和length值        |
| 0x07       | 7          | 窗口扩大因子为7(移位数)                   |







